<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Existing head content remains same -->
    <style>
        /* Add these new styles to existing CSS */
        .player-container {
            backdrop-filter: blur(10px);
        }

        .swipe-indicator {
            position: fixed;
            bottom: 30px;
            width: 100%;
            text-align: center;
            font-size: 12px;
            opacity: 0.7;
        }

        @media (orientation: landscape) {
            .player-content {
                flex-direction: row;
                align-items: center;
                max-width: 800px;
            }
            .album-art {
                width: 40vh;
                height: 40vh;
                margin-right: 30px;
            }
        }

        .shake-detected {
            animation: shake 0.5s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(10px); }
            75% { transform: translateX(-10px); }
        }

        .back-btn {
            font-size: 30px;
            padding: 15px;
            background: rgba(255,107,107,0.2);
            border-radius: 50%;
        }
    </style>
</head>
<body>
    <!-- Existing body content remains same -->
    <div class="swipe-indicator">Swipe left/right to change tracks</div>

    <script>
        // Add these new features to existing JavaScript
        let touchStartX = 0;
        let touchStartY = 0;
        let isSwiping = false;

        // Touch gesture handling
        document.addEventListener('touchstart', e => {
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
        });

        document.addEventListener('touchmove', e => {
            if (!isPlaying) return;
            const deltaX = e.touches[0].clientX - touchStartX;
            const deltaY = e.touches[0].clientY - touchStartY;
            
            if (Math.abs(deltaX) > 50 && Math.abs(deltaY) < 50) {
                isSwiping = true;
                if (deltaX > 0) changeSong(-1);
                else changeSong(1);
            }
        });

        document.addEventListener('touchend', () => {
            isSwiping = false;
        });

        // Device motion (shake detection)
        let lastShake = 0;
        window.addEventListener('devicemotion', e => {
            if (!isPlaying) return;
            const acceleration = e.acceleration;
            const threshold = 15;
            
            if (Math.abs(acceleration.x) > threshold || 
                Math.abs(acceleration.y) > threshold) {
                if (Date.now() - lastShake > 1000) {
                    document.querySelector('.album-art').classList.add('shake-detected');
                    setTimeout(() => {
                        document.querySelector('.album-art').classList.remove('shake-detected');
                    }, 500);
                    toggleShuffle();
                    changeSong(1);
                    lastShake = Date.now();
                }
            }
        });

        // Orientation change handling
        window.addEventListener('orientationchange', () => {
            const artwork = document.querySelector('.album-art');
            artwork.style.transform = `rotate(${window.orientation * 15}deg)`;
            setTimeout(() => {
                artwork.style.transform = 'none';
            }, 500);
        });

        // Service Worker for offline support
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then(() => console.log('Service Worker registered'))
                .catch(err => console.log('Service Worker failed', err));
        }

        // Media Session API for background playback
        function updateMediaSession() {
            if ('mediaSession' in navigator) {
                navigator.mediaSession.metadata = new MediaMetadata({
                    title: songs[currentSongIndex].title,
                    artist: songs[currentSongIndex].artist,
                    artwork: [
                        { src: songs[currentSongIndex].cover, sizes: '300x300' }
                    ]
                });

                navigator.mediaSession.setActionHandler('play', () => audio.play());
                navigator.mediaSession.setActionHandler('pause', () => audio.pause());
                navigator.mediaSession.setActionHandler('previoustrack', () => changeSong(-1));
                navigator.mediaSession.setActionHandler('nexttrack', () => changeSong(1));
            }
        }

        // Update loadSong function to include
        function loadSong(index) {
            // Existing code...
            updateMediaSession();
            setupWakeLock();
        }

        // Screen wake lock
        async function setupWakeLock() {
            if ('wakeLock' in navigator) {
                try {
                    const wakeLock = await navigator.wakeLock.request('screen');
                    audio.addEventListener('pause', () => wakeLock.release());
                } catch (err) {
                    console.log('Wake Lock failed:', err);
                }
            }
        }

        // Enhanced shuffle function
        function toggleShuffle() {
            isShuffle = !isShuffle;
            shuffleBtn.classList.toggle('active', isShuffle);
            if (isShuffle) {
                songs = songs.sort(() => Math.random() - 0.5);
                currentSongIndex = 0;
                initPlaylist();
            } else {
                songs = [...initialSongs];
                initPlaylist();
            }
        }

        // Add to existing initPlaylist function
        function initPlaylist() {
            // Existing code...
            document.querySelectorAll('.playlist-item').forEach(item => {
                item.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    const index = parseInt(item.dataset.index);
                    songs.splice(index, 1);
                    initPlaylist();
                });
            });
        }

        // Add these to existing event listeners
        audio.addEventListener('play', () => {
            // Existing code...
            if (!document.querySelector('.player-container').classList.contains('active')) {
                document.querySelector('.player-container').classList.add('active');
            }
        });

        // Handle file input for directory upload
        document.getElementById('file-input').addEventListener('change', function(e) {
            // Existing code...
            if (songs.length > 0 && !document.querySelector('.player-container').classList.contains('active')) {
                document.querySelector('.player-container').classList.add('active');
            }
        });
    </script>
</body>
</html>
